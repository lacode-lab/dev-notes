# aws-vault の仕組み

### 全体像

```
┌─────────────────────────────────────────────────────────────────────┐
│                         ローカルマシン                               │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │           OSのセキュアストレージ                             │   │
│  │   (macOS: Keychain / Windows: Credential Manager / Linux: Pass等)│
│  │                                                             │   │
│  │     🔐 永続アクセスキー（AKIA...）を暗号化して保存          │   │
│  │                                                             │   │
│  └──────────────────────────┬──────────────────────────────────┘   │
│                             │                                       │
│                             │ パスワードで解錠                      │
│                             ▼                                       │
│                    ┌────────────────┐                               │
│                    │   aws-vault    │                               │
│                    └────────┬───────┘                               │
│                             │                                       │
└─────────────────────────────┼───────────────────────────────────────┘
                              │
                              │ 永続キーを使ってリクエスト
                              ▼
                    ┌─────────────────┐
                    │     AWS STS     │
                    │   (クラウド)    │
                    └────────┬────────┘
                             │
                             │ 一時認証情報を発行
                             ▼
                    ┌─────────────────────────────────┐
                    │  一時キー（ASIA...）            │
                    │  + セッショントークン           │
                    │  + 有効期限                     │
                    └─────────────────────────────────┘
                             │
                             ▼
                    環境変数にセット → コマンド実行 → 終了で消滅
```

---

### 従来方式との比較

```
【従来】                              【aws-vault】

~/.aws/credentials                    OSセキュアストレージ
┌─────────────────┐                   ┌─────────────────┐
│ AKIA...        │                   │ 🔐 AKIA...     │
│ secret=xxxx    │  ← 平文！         │ (暗号化)       │
└─────────────────┘                   └────────┬────────┘
        │                                      │
        │                                      ▼
        │                              ┌──────────────┐
        │                              │  AWS STS     │
        │                              └──────┬───────┘
        │                                     │
        ▼                                     ▼
┌─────────────────┐                   ┌─────────────────┐
│ そのままAWSへ   │                   │ 一時キー ASIA...│
│ 永続キーを送信  │                   │ (期限付き)      │
└─────────────────┘                   └─────────────────┘

   ⚠️ 漏洩 = 永久に危険                ✅ 漏洩しても期限切れで無効化
```

---

### コマンド実行の流れ

```
$ aws-vault exec myprofile -- aws s3 ls

  ①  ユーザー
        │
        │  コマンド実行
        ▼
  ②  aws-vault
        │
        │  セキュアストレージから永続キー取得
        │  (パスワード入力が必要)
        ▼
  ③  AWS STS に一時認証をリクエスト
        │
        ▼
  ④  一時キーを環境変数にセット
        │
        │  AWS_ACCESS_KEY_ID=ASIA...
        │  AWS_SECRET_ACCESS_KEY=...
        │  AWS_SESSION_TOKEN=...
        ▼
  ⑤  サブプロセスで「aws s3 ls」を実行
        │
        ▼
  ⑥  コマンド終了 → 環境変数から認証情報が消える ✨
```

---

### なぜ安全か

```
┌────────────────────────────────────────────────────────────┐
│                                                            │
│   1. 永続キーがファイルに平文で残らない                    │
│      └─→ マルウェアやミスによる流出リスク↓                │
│                                                            │
│   2. 実際に使うのは一時キー（数時間で失効）                │
│      └─→ 万が一漏れても被害期間が限定的                   │
│                                                            │
│   3. 環境変数はプロセス終了で消える                        │
│      └─→ 認証情報が残り続けない                           │
│                                                            │
└────────────────────────────────────────────────────────────┘
```



## 1password と aws-vault
これは **MFA（多要素認証）の自動入力** のためですね。

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   aws-vault単体の場合                                           │
│   ─────────────────                                             │
│                                                                 │
│   aws-vault exec myprofile -- aws s3 ls                         │
│                    │                                            │
│                    ▼                                            │
│            ┌──────────────┐                                     │
│            │ MFAコード？   │  ← 毎回手入力が必要                │
│            │ > 123456_    │    （認証アプリ見て打ち込む）       │
│            └──────────────┘                                     │
│                                                                 │
│                    😫 めんどくさい                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   aws-vault + 1Password の場合                                  │
│   ────────────────────────────                                  │
│                                                                 │
│   aws-vault exec myprofile -- aws s3 ls                         │
│                    │                                            │
│                    ▼                                            │
│            ┌──────────────────┐      ┌─────────────────┐        │
│            │ MFAコード？       │ ───▶│ 1Password CLI   │        │
│            │                  │      │ op item get     │        │
│            │                  │◀──── │ --otp           │        │
│            │ (自動で入力される)│      └─────────────────┘        │
│            └──────────────────┘                                 │
│                                                                 │
│                    ✨ 楽ちん                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

つまり：

```
aws-vault の役割       → 永続キーの安全な保管 + 一時キー取得
1Password の役割       → MFAコード（TOTP）の自動入力
─────────────────────────────────────────────────────────────
組み合わせる理由       → セキュリティを維持しつつ手間を減らす
```

**セキュリティの話と利便性の話が混ざってる** から混乱しやすいんですよね。1Passwordとの連携は純粋に「MFA入力がだるい」を解決するためのもので、aws-vaultの本質（キーの安全な保管）とは別レイヤーの話です。
